apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: whoogle
  namespace: argocd
spec:
  destination:
    namespace: kube-system
    server: 'https://kubernetes.default.svc'
  source:
    helm:
      values: |
        controller:
          annotations:
            keel.sh/policy: "{{ k8s.keel.default_policy }}"
            keel.sh/approvals: "1"
            keel.sh/trigger: poll
            keel.sh/pollSchedule: "@every {{ k8s.keel.default_poll_schedule }}"
        image:
          repository: benbusby/whoogle-search
          imagePullPolicy: Always
        resources:
          requests:
            cpu: "{{ k8s.resources.cpu.request.default }}"
            memory: "{{ k8s.resources.memory.request.default }}"
        env:
          TZ: "{{ default_timezone }}"
        ingress:
          main:
            enabled: true
            ingressClassName: "traefik"
            annotations:
              cert-manager.io/cluster-issuer: "{{ k8s.cert_manager.cluster_issuer }}"
              traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
            hosts:
              - host: "whoogle.{{ secret.domain }}"
                paths:
                  - path: /
                    pathType: Prefix
            tls:
              - hosts:
                - "whoogle.{{ secret.domain }}"
                secretName: "whoogle-tls"
    repoURL: 'https://k8s-at-home.com/charts/'
    # targetRevision: 1.16.1
    chart: whoogle
  project: default
  syncPolicy:
    syncOptions:
      - CreateNamespace=true
  repoServer:
    volumes:
      - name: config
        configMap:
          name: config
      - name: secret-config
        secret:
          secretName: secret-config
    volumeMounts:
      - name: config
        mountPath: /config
      - name: secret-config
        mountPath: /secret

    automated:
      prune: false
      selfHeal: true
