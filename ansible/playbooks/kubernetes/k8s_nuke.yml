- name: Check if k3s is installed on the entire cluster
  hosts: k8s_cluster
  gather_facts: false
  become: true
  tasks:
    - name: Check if cluster is installed
      ansible.builtin.stat:
        path: "/usr/local/bin/k3s"
      register: k3s_check_installed
      check_mode: false

- name: Uninstall k3s on workers
  hosts: k8s_workers
  gather_facts: false
  become: true
  tasks:
    - name: Uninstall k3s on worker
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s-agent-uninstall.sh
      when: k3s_check_installed.stat.exists


- name: Uninstall k3s on masters
  hosts: k8s_masters
  gather_facts: false
  become: true
  tasks:
    - name: Uninstall k3s on master
      ansible.builtin.command:
        cmd: /usr/local/bin/k3s-uninstall.sh
      when: k3s_check_installed.stat.exists
