---
- hosts: localhost
  gather_facts: false
  become: false
  tasks:
    - name: create flux-system namespace
      k8s:
        name: flux-system
        api_version: v1
        kind: Namespace
        state: present

    - name: export flux gpg key
      command:
        cmd: "gpg --export-secret-keys --armor '{{ k8s.flux_fingerprint }}'"
      changed_when: False
      register: gpgkey

    - name: create gpg flux secret
      k8s:
        state: present
        definition:
          apiVersion: v1
          kind: Secret
          type: Opaque
          metadata:
            name: sops-gpg
            namespace: flux-system
          data:
            sops.asc: "{{ gpgkey.stdout | b64encode }}"

    - name: apply flux system (first time, will fail due to race condition)
      command:
        cmd: "kubectl apply --kustomize={{ playbook_dir }}/../../../cluster/base/flux-system"
      failed_when: False

    - name: apply flux system (second time)
      command:
        cmd: "kubectl apply --kustomize={{ playbook_dir }}/../../../cluster/base/flux-system"
