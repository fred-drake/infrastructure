---
- name: create velero namespace
  k8s:
    name: velero
    api_version: v1
    kind: Namespace
    state: present
    kubeconfig: "{{ kubeconfig_location }}"
  tags: velero

- name: create temp dir for velero
  ansible.builtin.tempfile:
    state: directory
    suffix: temp
  register: velero_dir
  changed_when: False
  tags: velero

- name: pull velero release from github
  get_url:
    url: "https://github.com/vmware-tanzu/velero/releases/download/v{{ services.velero.version }}/velero-v{{ services.velero.version }}-{{ services.velero.platform }}-{{ services.velero.arch }}.tar.gz"
    dest: "{{ velero_dir.path }}"
    mode: '0644'
  changed_when: False
  tags: velero

- name: unpack velero release package
  unarchive:
    src: "{{ velero_dir.path }}/velero-v{{ services.velero.version }}-{{ services.velero.platform }}-{{ services.velero.arch }}.tar.gz"
    dest: "{{ velero_dir.path }}"
    remote_src: true
  changed_when: False
  tags: velero

- name: create temp file
  ansible.builtin.tempfile:
    state: file
    suffix: temp
  register: credsfile
  changed_when: False
  tags: velero

- name: set credentials in temp file
  template:
    src: credentials
    dest: "{{ credsfile.path }}"
    mode: '0644'
  changed_when: False
  tags: velero

- name: install velero
  command: >
    {{ velero_dir.path }}/velero-v{{ services.velero.version }}-{{ services.velero.platform }}-{{ services.velero.arch }}/velero install 
    --provider aws 
    --plugins velero/velero-plugin-for-aws:v{{ services.velero.aws_version }} 
    --bucket velero 
    --secret-file {{ credsfile.path }} 
    --use-volume-snapshots=true 
    --kubeconfig {{ kubeconfig_location }}
    --backup-location-config region=default,s3ForcePathStyle="true",s3Url={{ services.velero.s3_url }} 
    --snapshot-location-config region="default" 
    --use-restic 
    --default-volumes-to-restic 
    --wait
  tags: velero

- name: set automatic backup
  command: >
    {{ velero_dir.path }}/velero-v{{ services.velero.version }}-{{ services.velero.platform }}-{{ services.velero.arch }}/velero schedule 
    create daily-backup --schedule="0 3 * * *" 
    --kubeconfig {{ kubeconfig_location }}
    --exclude-namespaces kube-system,velero,rook-ceph
  tags: velero
