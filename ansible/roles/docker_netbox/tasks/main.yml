---
- name: create postgres container
  community.docker.docker_container:
    name: netbox-db-postgres
    image: "postgres:12"
    pull: "{{ container_pull }}"
    hostname: netbox-db-postgres
    env:
      TZ: "{{ default_timezone }}"
      POSTGRES_USER: "{{ services.netbox_db_postgres.postgres_user }}"
      POSTGRES_PASSWORD: "{{ services.netbox_db_postgres.postgres_password }}"
      POSTGRES_DB: "{{ services.netbox_db_postgres.postgres_db }}"
    volumes: "{{ appdata_dir }}/netbox-db-postgres:/var/lib/postgresql/data"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ container_network }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ container_network }}"
        ipv4_address: "{{ services.netbox_db_postgres.ip }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
  notify:
    - deep prune docker
  tags:
    - netbox-db-postgres
    - docker_update

- name: create redis container
  community.docker.docker_container:
    name: netbox-db-redis
    image: "redis"
    pull: "{{ container_pull }}"
    hostname: netbox-db-redis
    env:
      TZ: "{{ default_timezone }}"
    volumes:
      - "{{ appdata_dir }}/netbox-db-redis:/data"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ container_network }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ container_network }}"
        ipv4_address: "{{ services.netbox_db_redis.ip }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
  notify:
    - deep prune docker
  tags:
    - netbox-db-redis
    - docker_update

- name: create application container
  community.docker.docker_container:
    name: "{{ role_name }}"
    image: "linuxserver/netbox:latest"
    pull: "{{ container_pull }}"
    hostname: "{{ role_name }}"
    env:
      TZ: "{{ default_timezone }}"
      PUID: "99"
      PGID: "100"
      SUPERUSER_EMAIL: "{{ services.netbox.superuser_email }}"
      SUPERUSER_PASSWORD: "{{ services.netbox.superuser_password }}"
      ALLOWED_HOST: "{{ services.netbox.allowed_host }}"
      DB_NAME: "{{ services.netbox_db_postgres.postgres_db }}"
      DB_USER: "{{ services.netbox_db_postgres.postgres_user }}"
      DB_PASSWORD: "{{ services.netbox_db_postgres.postgres_password }}"
      DB_HOST: "{{ services.netbox.db_host }}"
      DB_PORT: "{{ services.netbox.db_port }}"
      REDIS_HOST: "{{ services.netbox.redis_host }}"
      REDIS_PORT: "{{ services.netbox.redis_port }}"
    volumes:
      - "{{ appdata_dir }}/netbox:/config"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ container_network }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ container_network }}"
        ipv4_address: "{{ services.netbox.ip }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
  notify:
    - deep prune docker
  tags:
    - netbox
    - docker_update
