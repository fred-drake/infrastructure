- name: apply netbox namespace
  k8s:
    state: present
    definition: "{{ lookup('template', 'netbox-ns.yml') | from_yaml_all }}"
  tags:
    - netbox_redis
    - netbox_postgres
    - netbox_all

- name: apply netbox redis server
  k8s:
    state: present
    definition: "{{ lookup('template', 'netbox-redis.yml') | from_yaml_all }}"
  tags:
    - netbox_redis
    - netbox_all

- name: apply netbox postgres server
  k8s:
    state: present
    definition: "{{ lookup('template', 'netbox-postgres.yml') | from_yaml_all }}"
  tags:
    - netbox_postgres
    - netbox_all


- name: apply netbox server
  k8s:
    state: present
    definition: "{{ lookup('template', 'netbox.yml') | from_yaml_all }}"
  tags:
    - netbox
    - netbox_all

- name: delete netbox redis server
  k8s:
    state: absent
    definition: "{{ lookup('template', 'netbox-redis.yml') | from_yaml_all }}"
  tags:
    - never
    - delete_netbox_redis
    - delete_netbox_all

- name: delete netbox postgres server
  k8s:
    state: absent
    definition: "{{ lookup('template', 'netbox-postgres.yml') | from_yaml_all }}"
  tags:
    - never
    - delete_netbox_postgres
    - delete_netbox_all

- name: delete netbox server
  k8s:
    state: absent
    definition: "{{ lookup('template', 'netbox.yml') | from_yaml_all }}"
  tags:
    - never
    - delete_netbox
    - delete_netbox_all

- name: delete netbox namespace
  k8s:
    state: absent
    definition: "{{ lookup('template', 'netbox-ns.yml') | from_yaml_all }}"
  tags:
    - never
    - delete_netbox_all

- name: rollout netbox postgres database
  become: true
  command: kubectl rollout restart statefulset postgres-1 -n netbox
  tags:
    - never
    - restart_netbox_postgres
    - restart_netbox_all
