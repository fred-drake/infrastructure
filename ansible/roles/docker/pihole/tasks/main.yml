---
- name: create pihole container
  community.docker.docker_container:
    name: "{{ pihole_id }}"
    # image: "jacklul/pihole"
    image: "pihole/pihole:2021.11"
    pull: "{{ container_pull }}"
    hostname: "{{ secret.pihole[pihole_id].hostname }}"
    env:
      TZ: "{{ default_timezone }}"
      WEBPASSWORD: ""
      PIHOLE_DNS1: "8.8.8.8"
    volumes:
      - "{{ appdata_dir }}/{{ secret.pihole[pihole_id].hostname }}/etc/pihole:/etc/pihole"
      - "{{ appdata_dir }}/{{ secret.pihole[pihole_id].hostname }}/etc/pihole-updatelists:/etc/pihole-updatelists"
      - "{{ appdata_dir }}/{{ secret.pihole[pihole_id].hostname }}/dnsmasq:/etc/dnsmasq.d"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ secret.pihole[pihole_id].network }}"
    restart_policy: "{{ container_restart_policy }}"
    networks:
      - name: "{{ secret.pihole[pihole_id].network }}"
        ipv4_address: "{{ secret.pihole[pihole_id].address }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
    dns_servers:
      - "1.1.1.1"
    capabilities:
      - "NET_ADMIN"
  notify:
    - deep prune docker
  tags:
    - pihole
    - pihole_only

- name: generate pihole hosts from netbox
  connection: local
  become: false
  export_netbox_hostlist:
    netbox_api_prefix: "https://netbox.{{ secret.domain }}"
    netbox_token: "{{ secret.netbox.token }}"
  register: hostlist_results
  tags:
    - pihole
    - dns_update

- name: transfer pihole hosts
  template:
    src: hostlist.j2
    dest: "{{ appdata_dir }}/{{ secret.pihole[pihole_id].hostname }}/etc/pihole/custom.list"
    mode: "0644"
  notify:
    - restart DNS
  tags:
    - pihole
    - dns_update

- name: copy pihole-updatelists configuration
  copy:
    src: "pihole-updatelists.conf"
    dest: "{{ appdata_dir }}/{{ secret.pihole[pihole_id].hostname }}/etc/pihole-updatelists/pihole-updatelists.conf"
    mode: "0644"
  notify: execute pihole-updatelists
  tags:
    - pihole
    - dns_update
