---
- name: create application container
  community.docker.docker_container:
    name: "swag_internal"
    image: "linuxserver/swag:latest"
    pull: "{{ container_pull }}"
    hostname: "swag_internal"
    env:
      TZ: "{{ default_timezone }}"
      PUID: "99"
      PGID: "100"
      EMAIL: "{{ secret.services.swag_internal.email }}"
      URL: "{{ secret.services.swag_internal.url }}"
      SUBDOMAINS: "{{ secret.services.swag_internal.subdomains }}"
      ONLY_SUBDOMAINS: "{{ secret.services.swag_internal.only_subdomains }}"
      VALIDATION: "{{ secret.services.swag_internal.validation }}"
      DNSPLUGIN: "{{ secret.services.swag_internal.dnsplugin }}"
      STAGING: "{{ secret.services.swag_internal.staging }}"
    volumes:
      - "{{ appdata_dir }}/swag-internal:/config"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ secret.docker.network.container }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ secret.docker.network.container }}"
        ipv4_address: "{{ secret.services.swag_internal.ip }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
  notify:
    - deep prune docker
  tags:
    - swag_internal
    - docker_update

- name: sync proxy config files
  template:
    src: "{{ item }}"
    dest: "/var/lib/docker/mnt/appdata/swag-internal/nginx/proxy-confs/{{ item | basename | regex_replace('.j2$', '.conf') }}"
    owner: "99"
    group: "100"
    mode: "0664"
  with_fileglob:
    - "../templates/*.j2"
  notify:
    - restart nginx
  tags:
    - swag_internal
    - docker_update
