---
- name: Create postgres container
  community.docker.docker_container:
    name: netbox-db-postgres
    image: "postgres:12"
    pull: "{{ container_pull }}"
    hostname: netbox-db-postgres
    env:
      TZ: "{{ default_timezone }}"
      POSTGRES_USER: "{{ secret.services.netbox.postgres.user }}"
      POSTGRES_PASSWORD: "{{ secret.services.netbox.postgres.password }}"
      POSTGRES_DB: "{{ secret.services.netbox.postgres.database }}"
    volumes: "{{ appdata_dir }}/netbox-db-postgres:/var/lib/postgresql/data"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ secret.docker.network.container }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ secret.docker.network.container }}"
        ipv4_address: "{{ secret.services.netbox.postgres.ip }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
  notify:
    - deep prune docker
  tags:
    - netbox-db-postgres
    - docker_update

- name: Create redis container
  community.docker.docker_container:
    name: netbox-db-redis
    image: "redis"
    pull: "{{ container_pull }}"
    hostname: netbox-db-redis
    env:
      TZ: "{{ default_timezone }}"
    volumes:
      - "{{ appdata_dir }}/netbox-db-redis:/data"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ secret.docker.network.container }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ secret.docker.network.container }}"
        ipv4_address: "{{ secret.services.netbox.redis.ip }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
  notify:
    - deep prune docker
  tags:
    - netbox-db-redis
    - docker_update

- name: Create application container
  community.docker.docker_container:
    name: netbox
    image: "linuxserver/netbox:latest"
    pull: "{{ container_pull }}"
    hostname: netbox
    env:
      TZ: "{{ default_timezone }}"
      PUID: "99"
      PGID: "100"
      SUPERUSER_EMAIL: "{{ secret.services.netbox.superuser.email }}"
      SUPERUSER_PASSWORD: "{{ secret.services.netbox.superuser.password }}"
      ALLOWED_HOST: "{{ secret.services.netbox.allowed_host }}"
      DB_NAME: "{{ secret.services.netbox.postgres.database }}"
      DB_USER: "{{ secret.services.netbox.postgres.user }}"
      DB_PASSWORD: "{{ secret.services.netbox.postgres.password }}"
      DB_HOST: "{{ secret.services.netbox.postgres.ip }}"
      DB_PORT: "{{ secret.services.netbox.postgres.port }}"
      REDIS_HOST: "{{ secret.services.netbox.redis.ip }}"
      REDIS_PORT: "{{ secret.services.netbox.redis.port }}"
    volumes:
      - "{{ appdata_dir }}/netbox/config:/config"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ secret.docker.network.container }}"
    restart_policy: unless-stopped
    networks:
      - name: "{{ secret.docker.network.container }}"
        ipv4_address: "{{ secret.services.netbox.ip }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
  notify:
    - deep prune docker
  tags:
    - netbox
    - docker_update
