- name: Generate swarm-lb-managers nodes from netbox (with 'swarm-lb-managers' tags)
  connection: local
  become: false
  export_netbox_hostlist:
    netbox_api_prefix: "https://netbox.{{ secret.domain }}"
    netbox_token: "{{ secret.netbox.token }}"
    tag: swarm-lb-managers
  register: managers_hostlist_results
  run_once: true

- name: Generate swarm-lb-workers nodes from netbox (with 'swarm-lb-workers' tags)
  connection: local
  become: false
  export_netbox_hostlist:
    netbox_api_prefix: "https://netbox.{{ secret.domain }}"
    netbox_token: "{{ secret.netbox.token }}"
    tag: swarm-lb-workers
  register: workers_hostlist_results
  run_once: true

- name: Create config directory
  ansible.builtin.file:
    path: "{{ glusterfs_appdata_dir }}/swarm_lb"
    state: directory
    mode: '0755'

- name: Apply config template
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: "{{ glusterfs_appdata_dir }}/swarm_lb/haproxy.cfg"
    mode: '0644'
  run_once: true
  notify: Restart container

- name: Build Swarm LB container
  ansible.builtin.include_role:
    name: docker/container
  vars:
    container:
      name: swarm-lb
      repository: haproxy
      tag: latest
      ip: "{{ secret.services.swarm_lb.ip }}"
      volumes:
        - "{{ glusterfs_appdata_dir }}/swarm_lb:/usr/local/etc/haproxy:ro"
