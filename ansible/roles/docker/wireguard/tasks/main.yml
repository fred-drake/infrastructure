---
- name: create wireguard container
  community.docker.docker_container:
    name: wireguard
    image: "linuxserver/wireguard"
    pull: "{{ container_pull }}"
    hostname: wireguard
    env:
      TZ: "{{ default_timezone }}"
      PUID: "1000"
      PGID: "1000"
      SERVERURL: "vpn.{{ secret.domain }}"
      SERVERPORT: "51820"
      PEERS: "1"
      PEERDNS: auto
      INTERNAL_SUBNET: 10.13.13.0
      ALLOWEDIPS: 0.0.0.0/0
      PIHOLE_DNS1: "8.8.8.8"
    volumes:
      - "{{ appdata_dir }}/wireguard:/config"
      - "/lib/modules:/lib/modules"
    container_default_behavior: "{{ container_default_behavior }}"
    network_mode: "{{ secret.pihole[pihole_id].network }}"
    restart_policy: "{{ container_restart_policy }}"
    networks:
      - name: "{{ secret.docker.network.admin }}"
        ipv4_address: "{{ secret.pihole[pihole_id].address }}"
    networks_cli_compatible: "{{ container_networks_cli_compatible }}"
    state: "{{ container_state }}"
    dns_servers:
      - "1.1.1.1"
    capabilities:
      - "NET_ADMIN"
      - "SYS_MODULE"
    sysctls:
      net.ipv4.conf.all.src_valid_mark: "1"
  notify:
    - deep prune docker
  tags:
    - pihole
    - pihole_only
