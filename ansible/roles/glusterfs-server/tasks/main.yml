- name: Parted brick device
  ansible.builtin.parted:
    device: "{{ glusterfs_brick_device }}"
    label: gpt
    number: 1
    flags: [lvm]
    state: present
- name: Create volume on pv brick device partition 1
  ansible.builtin.lvg:
    vg: vg_gluster
    pvs: "{{ glusterfs_brick_partition }}"
- name: Create a logical volume
  ansible.builtin.lvol:
    vg: vg_gluster
    lv: brick0
    size: 100%FREE
    shrink: false
- name: Create a xfs filesystem
  ansible.builtin.filesystem:
    fstype: xfs
    dev: /dev/vg_gluster/brick0
- name: Create dir
  ansible.builtin.file:
    path: /export
    state: directory
    mode: '0755'
- name: Create dir
  ansible.builtin.file:
    path: /export/brick0
    state: directory
    mode: '0755'
- name: Mount brick
  ansible.builtin.mount:
    path: /export/brick0
    src: /dev/vg_gluster/brick0
    fstype: xfs
    dump: "1"
    passno: "2"
    state: mounted

- name: Add apt repo
  ansible.builtin.apt_repository:
    repo: ppa:gluster/glusterfs-10
    state: present
- name: Install glusterfs server
  ansible.builtin.apt:
    name: glusterfs-server
    update_cache: true
- name: Open port for glusterfs communication
  ansible.builtin.ufw:
    rule: allow
    port: '5667'
    proto: any
- name: Ensure glusterfs is started
  ansible.builtin.systemd:
    name: glusterd
    enabled: true
    state: started
    masked: false

- name: Create a trusted storage pool
  ansible.builtin.gluster_peer:
    state: present
    nodes: "{{ groups['glusterfs_server'] }}"
  run_once: true

- name: Check if volume already exists
  ansible.builtin.command: gluster volume info vol01
  ignore_errors: true
  register: volume_status
  changed_when: false

- name: Create gluster volume
  ansible.builtin.gluster_volume:
    state: present
    name: vol01
    brick: /export/brick0/vol01
    replicas: 3
    cluster: "{{ groups['glusterfs_server'] }}"
  run_once: true
  when: volume_status.rc != 0

- name: Get volume info
  ansible.builtin.command: gluster volume info
  register: volume_info
  run_once: true
  changed_when: false
- name: Show volume info
  ansible.builtin.debug:
    msg: "{{ volume_info.stdout_lines }}"
  run_once: true

## Nuke volume and storage pool
# - name: warning
#   pause:
#     prompt: "WARNING: This will destroy your volume.  Be sure this is what you want!!"
#     seconds: 10
#   tags:
#     - never
#     - nuke
# - name: delete gluster volume
#   gluster_volume:
#     state: absent
#     name: vol01
#   run_once: true
#   tags:
#     - never
#     - nuke

# - name: "remove trusted storage pool"
#   gluster_peer:
#     state: absent
#     nodes: "{{ groups['glusterfs_server'][1:] }}"
#   run_once: true
#   tags:
#     - never
#     - nuke
# - name: remove vol01
#   file:
#     path: /export/brick0/vol01
#     state: absent
#   tags:
#     - never
#     - nuke
