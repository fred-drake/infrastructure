- name: Update opkg
  ansible.builtin.command: opkg update
  changed_when: true

- name: Install packages
  ansible.builtin.command: >
    opkg install
    python3-email
    python3-urllib
    shadow-usermod
  changed_when: true

- name: Set authorized keys
  become: false
  ansible.posix.authorized_key:
    user: "{{ ansible_user }}"
    state: present
    key: "{{ lookup('file', '{{ item }}') }}"
    path: /etc/dropbear/authorized_keys
  with_fileglob:
    - "../../public_keys/*"

- name: Update user password
  ansible.builtin.user:
    name: "{{ ansible_user }}"
    update_password: always
    password: "{{ ssh_password_hash }}"

- name: Network configuration
  ansible.builtin.copy:
    src: "network-{{ ansible_host.split('.')[0] }}"
    dest: "/etc/config/network"
    mode: '0644'
  notify:
    - reboot
    - wait for reboot
