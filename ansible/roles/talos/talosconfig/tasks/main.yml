- name: Create temp file for talosconfig template
  ansible.builtin.tempfile:
    state: file
    suffix: talosconfig
  register: config_temp_file
  changed_when: false

- name: Build IP addresses of control plane machines
  ansible.builtin.set_fact:
    endpoint_ip_addresses: "{{ endpoint_ip_addresses }} + [ '{{ lookup('dig', '{{ item }}.{{ secret.domain }}') }}' ]"
  with_items: "{{ groups['talos_control_planes'] }}"

- name: Build talosconfig
  ansible.builtin.template:
    src: talosconfig.j2
    dest: "{{ config_temp_file.path }}"
    mode: '0644'
  changed_when: false

- name: Merge talosconfig
  ansible.builtin.command: "talosctl config merge {{ config_temp_file.path | quote }}"
  changed_when: true
  register: merge_output

- name: Display merge output
  ansible.builtin.debug:
    var: merge_output.stdout
