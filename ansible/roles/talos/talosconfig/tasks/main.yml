- name: create temp file for talosconfig template
  tempfile:
    state: file
    suffix: talosconfig
  register: config_temp_file
  changed_when: false

- name: build IP addresses of control plane machines
  set_fact:
    endpoint_ip_addresses: "{{ endpoint_ip_addresses }} + [ '{{ lookup('dig', '{{ item }}.{{ secret.domain }}') }}' ]"
  with_items: "{{ groups['talos_control_planes'] }}"

- name: build talosconfig
  template:
    src: talosconfig.j2
    dest: "{{ config_temp_file.path }}"
  changed_when: false

- name: merge talosconfig
  command: "talosctl config merge {{ config_temp_file.path|quote }}"
  register: merge_output

- name: display merge output
  debug:
    var: merge_output.stdout
