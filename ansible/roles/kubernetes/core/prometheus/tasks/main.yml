- name: prometheus helm repo
  kubernetes.core.helm_repository:
    name: prometheus-community
    repo_url: https://prometheus-community.github.io/helm-charts
  tags: prometheus

- name: kube-state-metrics helm
  kubernetes.core.helm:
    name: prometheus
    chart_ref: prometheus-community/kube-state-metrics
    release_namespace: prometheus
    create_namespace: true
    values:
      env:
        TZ: "{{ default_timezone }}"
  tags: prometheus

- name: prometheus helm
  kubernetes.core.helm:
    name: prometheus
    chart_ref: prometheus-community/prometheus
    release_namespace: prometheus
    create_namespace: true
    values:
      env:
        TZ: "{{ default_timezone }}"
      image:
        imagePullPolicy: Always
      resources:
        requests:
          cpu: "{{ k8s.resources.cpu.request.default }}"
          memory: "{{ k8s.resources.memory.request.default }}"
      extraScrapeConfigs: |
        - job_name: 'gateway-snmp'
          static_configs:
            - targets:
              - "gateway-50.{{ secret.domain }}"
          metrics_path: /snmp
          params:
            module: [pfsense]
          relabel_configs:
            - source_labels: [__address__]
              target_label: __param_target
            - source_labels: [__param_target]
              target_label: instance
            - target_label: __address__
              replacement: snmp-exporter.prometheus.svc.cluster.local:9116
      server:
        statefulSet:
          enabled: true
      nodeExporter:
          tolerations:
            - key: node-role.kubernetes.io/master
              value: "true"
              effect: "NoSchedule"
      monitoring:
        enabled: false
  tags: prometheus

- name: prometheus ingress
  k8s:
    state: present
    definition: "{{ lookup('template', 'prometheus.yml') | from_yaml_all }}"
  tags: prometheus

- name: prometheus snmp-exporter
  k8s:
    state: present
    definition: "{{ lookup('template', 'snmp-exporter.yml') | from_yaml_all }}"
  tags: prometheus
