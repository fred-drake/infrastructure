- name: rook-ceph helm repo
  kubernetes.core.helm_repository:
    name: rook-ceph-charts
    repo_url: https://charts.rook.io/release
  tags: rook-ceph

- name: rook-ceph helm
  kubernetes.core.helm:
    name: rook-ceph
    chart_ref: rook-ceph-charts/rook-ceph
    chart_version: v1.7.4
    release_namespace: rook-ceph
    create_namespace: true
    values:
      env:
        TZ: "{{ default_timezone }}"
  tags: rook-ceph

- name: rook-ceph cluster
  k8s:
    state: present
    definition: "{{ lookup('template', 'cluster.yml') | from_yaml_all }}"
  tags: rook-ceph

- name: rook-ceph toolbox
  k8s:
    state: present
    definition: "{{ lookup('template', 'toolbox.yml') | from_yaml_all }}"
  tags: rook-ceph

- name: rook-ceph remove-default-storage
  k8s:
    state: present
    definition: "{{ lookup('template', 'remove-default-storage.yml') | from_yaml_all }}"
  tags: rook-ceph

- name: rook-ceph storageclass
  k8s:
    state: present
    definition: "{{ lookup('template', 'storageclass.yml') | from_yaml_all }}"
  tags: rook-ceph

- name: rook-ceph dashboard-ingress
  k8s:
    state: present
    definition: "{{ lookup('template', 'dashboard-ingress.yml') | from_yaml_all }}"
  tags: rook-ceph

- name: exclude rook-ceph namespace from velero
  k8s:
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: rook-ceph
        annotations:
          velero.io/exclude-from-backup: "true"
  tags: rook-ceph
