- name: metallb helm repo
  kubernetes.core.helm_repository:
    name: traefik
    repo_url: https://helm.traefik.io/traefik
  tags: traefik

- name: traefik helm
  kubernetes.core.helm:
    name: traefik
    chart_ref: traefik/traefik
    release_namespace: networking
    create_namespace: true
    values:
      image:
        name: ghcr.io/k8s-at-home/traefik
        imagePullPolicy: Always
      deployment:
        kind: Deployment
        replicas: 1
      service:
        enabled: true
        type: LoadBalancer
        spec:
          loadBalancerIP: "{{ k8s.traefik.address }}"
          externalTrafficPolicy: Local
      logs:
        general:
          format: json
          level: DEBUG
        access:
          enabled: true
          format: json
      ingressClass:
        enabled: true
        isDefaultClass: true
        fallbackApiVersion: v1
      ingressRoute:
        dashboard:
          enabled: false
      globalArguments:
        - "--api.insecure=true"
        - "--serverstransport.insecureskipverify=true"
        - "--providers.kubernetesingress.ingressclass=traefik"
        - "--metrics.prometheus=true"
        - "--metrics.prometheus.entryPoint=metrics"
      additionalArguments:
        - "--providers.kubernetesingress.ingressendpoint.ip={{ k8s.traefik.address }}"
        - "--providers.kubernetescrd.allowexternalnameservices=true"
        - "--providers.kubernetesingress.allowexternalnameservices=true"
      ports:
        traefik:
          expose: true
        web:
          redirectTo: websecure
        websecure:
          tls:
            enabled: true
            options: "default"
        metrics:
          port: 8082
          expose: true
          exposedPort: 8082
      tlsOptions:
        default:
          minVersion: VersionTLS12
          maxVersion: VersionTLS13
          sniStrict: true
      pilot:
        enabled: false
      experimental:
        plugins:
          enabled: false
      resources:
        requests:
            cpu: "{{ k8s.resources.cpu.request.default }}"
            memory: "{{ k8s.resources.memory.request.default }}"
  tags: traefik

- name: traefik dashboard
  k8s:
    state: present
    definition: "{{ lookup('template', 'dashboard-ingress.yml') | from_yaml_all }}"
  tags: traefik
