# - name: uptime-kuma
#   k8s:
#     state: present
#     definition: "{{ lookup('template', 'uptime-kuma.yml') | from_yaml_all }}"
#   tags:
#     - uptime-kuma

- name: duyet helm repo
  kubernetes.core.helm_repository:
    name: duyet
    repo_url: https://duyet.github.io/charts
  tags: uptime-kuma

- name: uptime-kuma helm
  kubernetes.core.helm:
    name: uptime-kuma
    chart_ref: duyet/uptime-kuma
    release_namespace: uptime-kuma
    create_namespace: true
    values:
      image:
        imagePullPolicy: Always
      resources:
        requests:
          cpu: "{{ k8s.resources.cpu.request.default }}"
          memory: "{{ k8s.resources.memory.request.default }}"
      env:
        - name: TZ
          value: "{{ default_timezone }}"
      ingress:
        enabled: true
        ingressClassName: "traefik"
        annotations:
          cert-manager.io/cluster-issuer: "{{ k8s.cert_manager.cluster_issuer }}"
          traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
        hosts:
          - host: "uptime-kuma.{{ secret.domain }}"
            paths:
              - path: /
                pathType: Prefix
        tls:
          - hosts:
            - "uptime-kuma.{{ secret.domain }}"
            secretName: "uptime-kuma-tls"
  tags: uptime-kuma
