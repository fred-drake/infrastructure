---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-secret
  namespace: netbox
type: Opaque
stringData:
  superUserPassword: "{{ secret.netbox.postgres.superuser_password }}"
  replicationUserPassword: "{{ secret.netbox.postgres.replication_password }}"
# ---
# apiVersion: apps/v1
# kind: StatefulSet
# metadata:
#   name: postgres-1
#   namespace: netbox
# spec:
#   serviceName: postgres-1
#   replicas: 1
#   selector:
#     matchLabels:
#       app: postgres-1
#   volumeClaimTemplates:
#   - metadata:
#       name: data
#     spec:
#       accessModes: ["ReadWriteOnce"]
#       resources:
#         requests:
#           storage: 20Gi
#   template:
#     metadata:
#       labels:
#         app: postgres-1
#     spec:
#       containers:
#       - name: busybox
#         image: busybox
#         args:
#           - sleep
#           - "1000000"
#         imagePullPolicy: Always
#         resources:
#           requests:
#             cpu: "{{ k8s.resources.cpu.request.default }}"
#             memory: "{{ k8s.resources.memory.request.default }}"
#         env:
#         - name: TZ
#           value: "{{ default_timezone }}"
#         volumeMounts:
#         - name: data
#           mountPath: /config
---
apiVersion: kubegres.reactive-tech.io/v1
kind: Kubegres
metadata:
  name: postgres
  namespace: netbox
spec:
  replicas: 1
  image: postgres:12
  imagePullPolicy: Always
  resources:
    requests:
      cpu: "{{ k8s.resources.cpu.request.default }}"
      memory: "{{ k8s.resources.memory.request.default }}"
  database:
    size: 20Gi
  env:
    - name: POSTGRES_DB
      value: netbox
    - name: POSTGRES_USER
      value: "{{ secret.netbox.postgres.user }}"
    - name: POSTGRES_PASSWORD
      valueFrom:
        secretKeyRef:
          name: postgres-secret
          key: superUserPassword
    - name: POSTGRES_REPLICATION_PASSWORD
      valueFrom:
        secretKeyRef:
          name: postgres-secret
          key: replicationUserPassword
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: netbox
spec:
  selector:
    app: postgres
  type: NodePort
  ports:
    - port: 5432
      targetPort: 5432
