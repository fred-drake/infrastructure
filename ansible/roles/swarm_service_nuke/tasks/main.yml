- name: Get swarm service facts
  swarm_service_facts:
    domain: "{{ secret.domain }}"
    cifs_server: "{{ cifs_server }}"
    cifs_mount_options: "{{ cifs_docker_mount_options }}"
    nfs_server: "{{ secret.nfs.host }}"
    nfs_mount_options: "{{ secret.nfs.default_options }}"
    glusterfs_appdata_dir: "{{ glusterfs_appdata_dir }}"
    service: "{{ service }}"
  register: sf

- name: Debug
  ansible.builtin.debug:
    var: sf.facts

- name: Remove backup service, if applicable
  community.docker.docker_swarm_service:
    name: "backup-{{ service.name }}"
    state: absent

- name: Remove containers
  community.docker.docker_swarm_service:
    name: "{{ item.name }}"
    state: absent
  loop: "{{ sf.facts.services }}"
  loop_control:
    label: "{{ item.name }}"
  notify: Prune docker
