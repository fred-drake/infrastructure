- name: install dependencies
  apt:
    name:
      - git
      - python3-pip
      - supervisor
    state: present
  tags:
    - nhl
    - mlb

- name: stat supervisorctl
  stat:
    path: /usr/bin/supervisorctl
  register: supervisorctl_file
  tags:
    - never
    - nuke

- name: stop scoreboard
  command: supervisorctl stop scoreboard
  when: supervisorctl_file.stat.exists
  tags:
    - never
    - nuke

- name: wipe current implementation of nhl scoreboard for a reinstall
  file:
    path: /opt/nhl-led-scoreboard
    state: absent
  tags:
    - never
    - nuke

- name: wipe current implementation of mlb scoreboard for a reinstall
  file:
    path: /opt/mlb-led-scoreboard
    state: absent
  tags:
    - never
    - nuke

- name: determine if nhl scoreboard is already installed
  stat:
    path: /opt/nhl-led-scoreboard
  register: nhl_scoreboard_dir
  tags:
    - nhl

- name: determine if mlb scoreboard is already installed
  stat:
    path: /opt/mlb-led-scoreboard
  register: mlb_scoreboard_dir
  tags:
    - mlb

- name: checkout nhl scoreboard
  git:
    repo: "https://github.com/fred-drake/nhl-led-scoreboard"
    # repo: https://github.com/riffnshred/nhl-led-scoreboard
    dest: /opt/nhl-led-scoreboard
    depth: "1"
    version: mqtt
  when: not nhl_scoreboard_dir.stat.exists
  tags:
    - nhl

- name: checkout mlb scoreboard
  git:
    repo: "https://github.com/MLB-LED-Scoreboard/mlb-led-scoreboard.git"
    dest: /opt/mlb-led-scoreboard
    depth: "1"
  when: not mlb_scoreboard_dir.stat.exists
  tags:
    - mlb

- name: apply nhl scoreboard configuration
  template:
    src: nhl-config.json.j2
    dest: /opt/nhl-led-scoreboard/config/config.json
    mode: '0644'
  notify: restart scoreboard
  tags:
    - nhl

- name: apply mlb scoreboard configuration
  template:
    src: mlb-config.json.j2
    dest: /opt/mlb-led-scoreboard/config.json
    mode: '0644'
  notify: restart scoreboard
  tags:
    - mlb

- name: apply mlb scoreboard colors configurations
  copy:
    src: colors
    dest: /opt/mlb-led-scoreboard
    mode: '0755'
  notify: restart supervisor
  tags: 
    - mlb

- name: compile nhl scoreboard
  shell: cd /opt/nhl-led-scoreboard; ./scripts/install.sh
  when: not nhl_scoreboard_dir.stat.exists
  tags:
    - nhl

- name: compile mlb scoreboard
  shell: cd /opt/mlb-led-scoreboard; ./install.sh config.json
  when: not mlb_scoreboard_dir.stat.exists
  tags:
    - mlb

- name: configure audio config flag
  replace:
    path: /boot/config.txt
    regexp: '^dtparam=audio=on$'
    replace: 'dtparam=audio=off'
  notify: reboot system
  tags:
    - nhl
    - mlb

- name: configure supervisor
  blockinfile:
    state: present
    path: /etc/supervisor/supervisord.conf
    block: "{{ lookup('file', 'supervisord-block.conf') }}"
  notify: restart supervisor
  tags:
    - nhl
    - mlb

- name: apply nhl scoreboard supervisor configuration
  copy:
    src: nhl-scoreboard.conf
    dest: /etc/supervisor/conf.d/scoreboard.conf
    mode: '0644'
  notify: restart supervisor
  tags: nhl

- name: apply mlb scoreboard supervisor configuration
  copy:
    src: mlb-scoreboard.conf
    dest: /etc/supervisor/conf.d/scoreboard.conf
    mode: '0644'
  notify: restart supervisor
  tags: mlb
