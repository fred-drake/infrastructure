- name: Install dependencies
  ansible.builtin.apt:
    name:
      - git
      - python3-pip
      - supervisor
    state: present
  tags:
    - nhl
    - mlb

- name: Stat supervisorctl
  ansible.builtin.stat:
    path: /usr/bin/supervisorctl
  register: supervisorctl_file
  tags:
    - never
    - nuke

- name: Stop scoreboard
  community.general.supervisorctl:
    name: scoreboard
    state: stopped
  when: supervisorctl_file.stat.exists
  tags:
    - never
    - nuke

- name: Wipe current implementation of nhl scoreboard for a reinstall
  ansible.builtin.file:
    path: /opt/nhl-led-scoreboard
    state: absent
  tags:
    - never
    - nuke

- name: Wipe current implementation of mlb scoreboard for a reinstall
  ansible.builtin.file:
    path: /opt/mlb-led-scoreboard
    state: absent
  tags:
    - never
    - nuke

- name: Determine if nhl scoreboard is already installed
  ansible.builtin.stat:
    path: /opt/nhl-led-scoreboard
  register: nhl_scoreboard_dir
  tags:
    - nhl

- name: Determine if mlb scoreboard is already installed
  ansible.builtin.stat:
    path: /opt/mlb-led-scoreboard
  register: mlb_scoreboard_dir
  tags:
    - mlb

- name: Checkout nhl scoreboard
  ansible.builtin.git:
    repo: "https://github.com/fred-drake/nhl-led-scoreboard"
    # repo: https://github.com/riffnshred/nhl-led-scoreboard
    dest: /opt/nhl-led-scoreboard
    depth: "1"
    version: mqtt
  when: not nhl_scoreboard_dir.stat.exists
  tags:
    - nhl

- name: Checkout mlb scoreboard
  ansible.builtin.git:
    repo: "https://github.com/MLB-LED-Scoreboard/mlb-led-scoreboard.git"
    version: master
    dest: /opt/mlb-led-scoreboard
    depth: "1"
  when: not mlb_scoreboard_dir.stat.exists
  tags:
    - mlb

- name: Apply nhl scoreboard configuration
  ansible.builtin.template:
    src: nhl-config.json.j2
    dest: /opt/nhl-led-scoreboard/config/config.json
    mode: '0644'
  notify: restart scoreboard
  tags:
    - nhl

- name: Apply mlb scoreboard configuration
  ansible.builtin.template:
    src: mlb-config.json.j2
    dest: /opt/mlb-led-scoreboard/config.json
    mode: '0644'
  notify: restart scoreboard
  tags:
    - mlb

- name: Apply mlb scoreboard colors configurations
  ansible.builtin.copy:
    src: colors
    dest: /opt/mlb-led-scoreboard
    mode: '0755'
  notify: restart supervisor
  tags:
    - mlb

- name: Compile nhl scoreboard
  ansible.builtin.shell: cd /opt/nhl-led-scoreboard; ./scripts/install.sh
  when: not nhl_scoreboard_dir.stat.exists
  tags:
    - nhl

- name: Compile mlb scoreboard
  ansible.builtin.shell: cd /opt/mlb-led-scoreboard; ./install.sh config.json
  when: not mlb_scoreboard_dir.stat.exists
  tags:
    - mlb

- name: Configure audio config flag
  ansible.builtin.replace:
    path: /boot/config.txt
    regexp: '^dtparam=audio=on$'
    replace: 'dtparam=audio=off'
  notify: reboot system
  tags:
    - nhl
    - mlb

- name: Configure supervisor
  ansible.builtin.blockinfile:
    state: present
    path: /etc/supervisor/supervisord.conf
    block: "{{ lookup('file', 'supervisord-block.conf') }}"
  notify: restart supervisor
  tags:
    - nhl
    - mlb

- name: Apply nhl scoreboard supervisor configuration
  ansible.builtin.copy:
    src: nhl-scoreboard.conf
    dest: /etc/supervisor/conf.d/scoreboard.conf
    mode: '0644'
  notify: restart supervisor
  tags: nhl

- name: Apply mlb scoreboard supervisor configuration
  ansible.builtin.copy:
    src: mlb-scoreboard.conf
    dest: /etc/supervisor/conf.d/scoreboard.conf
    mode: '0644'
  notify: restart supervisor
  tags: mlb
