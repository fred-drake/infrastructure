- name: Run routines common to master node manipulation
  ansible.builtin.include_role:
    name: swarm
    tasks_from: master_common

- name: Get the manager join-token
  delegate_to: "{{ groups['swarm_initial_master'][0] }}"
  ansible.builtin.command: docker swarm join-token --quiet manager
  register: manager_token
  changed_when: false

- name: Add manager to swarm
  community.docker.docker_swarm:
    state: join
    # join_token: "{{ hostvars[groups['swarm_initial_master'][0]]['manager_token']['stdout'] }}"
    join_token: "{{ manager_token.stdout }}"
    # remote_addrs: "{{ hostvars[groups['swarm_initial_master'][0]]['ansible_default_ipv4']['address'] }}:2377"
    remote_addrs: "{{ lookup('community.general.dig', groups['swarm_initial_master'][0] + '.' + secret.domain + '.') }}:2377"
  when: swarm_status.rc != 0
