- name: Run routines common to master node manipulation
  ansible.builtin.include_role:
    name: swarm
    tasks_from: master_common

### This doesn't work and I'm not sure why right now... using command as workaround
# - name: initialize docker swarm
#   docker_swarm:
#     state: present
#     advertise_addr: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
#   when: swarm_status.rc != 0
#   run_once: true

- name: Initialize docker swarm
  ansible.builtin.command: docker swarm init --advertise-addr "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"
  when: swarm_status.rc != 0
  run_once: true

- name: Get the manager join-token
  ansible.builtin.command: docker swarm join-token --quiet manager
  register: manager_token
  changed_when: false

- name: Get the worker join-token
  ansible.builtin.command: docker swarm join-token --quiet worker
  register: worker_token
  changed_when: false
