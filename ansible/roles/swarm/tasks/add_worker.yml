# - name: Check if token is available
#   ansible.builtin.debug:
#     msg: Cannot find token.  Did you not include the swarm initial master in the host list?
#   failed_when: false
#   when: hostvars[groups['swarm_initial_master'][0]]['worker_token'] is not defined

- name: Get the worker join-token
  delegate_to: "{{ groups['swarm_initial_master'][0] }}"
  ansible.builtin.command: docker swarm join-token --quiet worker
  register: worker_token
  changed_when: false

# - name: debug
#   ansible.builtin.debug:
#     msg: "{{ lookup('community.general.dig', groups['swarm_initial_master'][0] + '.' + secret.domain + '.') }}"

- name: Add worker to the swarm
  community.docker.docker_swarm:
    state: join
    # join_token: "{{ hostvars[groups['swarm_initial_master'][0]]['worker_token']['stdout'] }}"
    join_token: "{{ worker_token.stdout }}"
    remote_addrs: "{{ lookup('community.general.dig', groups['swarm_initial_master'][0] + '.' + secret.domain + '.') }}:2377"
