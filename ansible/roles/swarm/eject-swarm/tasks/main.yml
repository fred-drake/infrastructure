- name: Ejection warning
  ansible.builtin.pause:
    prompt: You're about to eject nodes from docker swarm
    seconds: 10

- name: Demote master before removal
  ansible.builtin.command: "docker node demote {{ inventory_hostname }}"
  delegate_to: "{{ groups['swarm_initial_master'][0] }}"
  failed_when: false
  when: inventory_hostname not in groups['swarm_workers']

- name: Remove from cluster
  ansible.builtin.command: "docker node rm {{ inventory_hostname }} --force"
  delegate_to: "{{ groups['swarm_initial_master'][0] }}"
  failed_when: false
  register: node_rm
  changed_when: node_rm.rc == 0

- name: Leave the swarm
  community.docker.docker_swarm:
    state: absent
    force: true
