---
- name: Create pivpn directory
  ansible.builtin.file:
    path: /etc/pivpn/wireguard
    state: directory
    mode: "0775"

- name: Set pivpn configuration
  ansible.builtin.template:
    src: setupVars.j2
    dest: /etc/pivpn/wireguard/setupVars.conf
    mode: "0644"

- name: Check for binary
  ansible.builtin.stat:
    path: /usr/local/bin/pivpn
  register: pivpn_binary

- name: Download install script
  ansible.builtin.get_url:
    url: https://install.pivpn.io
    dest: ~/pivpn-install.sh
    mode: u+rwx
  when: not pivpn_binary.stat.exists

- name: Run install script
  ansible.builtin.command: ~/pivpn-install.sh --unattended /etc/pivpn/wireguard/setupVars.conf
  when: not pivpn_binary.stat.exists

- name: Copy configuration files
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/roles/pivpn/files/configuration/etc/wireguard"
    dest: "/etc/"
    mode: "0600"
    directory_mode: "0700"
  notify:
    - restart service
  tags:
    - update

- name: Execute service restart if necessary
  ansible.builtin.meta: flush_handlers
  tags:
    - update

- name: Check if service is started
  ansible.builtin.service:
    name: wg-quick@wg0
    state: started
  notify:
    - fail because service is stopped
  tags:
    - update
