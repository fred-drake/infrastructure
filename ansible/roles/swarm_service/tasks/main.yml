- name: Get swarm service facts
  swarm_service_facts:
    domain: "{{ secret.domain }}"
    cifs_server: "{{ cifs_server }}"
    cifs_mount_options: "{{ cifs_docker_mount_options }}"
    nfs_server: "{{ secret.nfs.host }}"
    nfs_mount_options: "{{ secret.nfs.default_options }}"
    glusterfs_appdata_dir: "{{ glusterfs_appdata_dir }}"
    service: "{{ service }}"
  register: sf

- name: Call initialization role
  ansible.builtin.include_role:
    name: "{{ service.init_role }}"
    tasks_from: "{{ service.init_role_tasks_from | default(omit) }}"
  when: service.init_role is defined

- name: Add network
  community.docker.docker_network:
    name: "{{ service.name }}"
    driver: overlay
  when: sf.facts.service_network

- name: Create bind directories for service
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0777'
  loop: "{{ sf.facts.bind_mount_source_paths }}"

- name: "Create container services"
  community.docker.docker_swarm_service:
    name: "{{ item.name }}"
    image: "{{ item.repository }}:{{ item.tag }}"
    placement:
      constraints: "{{ item.constraints }}"
    networks: "{{ item.networks | default(omit) }}"
    labels: "{{ item.labels | default(omit) }}"
    mounts: "{{ item.mounts | default(omit) }}"
    publish: "{{ item.publish | default(omit) }}"
    mode: "{{ item.mode | default(omit) }}"
    env: "{{ item.env | default(omit) }}"
    command: "{{ item.command | default(omit) }}"
    endpoint_mode: "{{ item.endpoint_mode | default(omit) }}"
  loop: "{{ sf.facts.services }}"
  loop_control:
    label: "{{ item.name }}"

- name: Call post-creation role
  ansible.builtin.include_role:
    name: "{{ service.post_role }}"
    tasks_from: "{{ service.post_role_tasks_from | default(omit) }}"
  when: service.post_role is defined

- name: "Create backup service"
  community.docker.docker_swarm_service:
    name: "backup-{{ service.name }}"
    image: ghcr.io/fred-drake/k8s-backup:latest
    placement:
      constraints: node.role==worker
    networks:
      - "{{ sf.facts.name }}"
    mounts: "{{ default_mounts + (backup_mounts | default([])) }}"
    env: "{{ default_backup_env | combine(service.backup_env | default({})) }}"
  when: service.backup is defined and service.backup
