- name: check if cluster is installed
  ansible.builtin.stat:
    path: "/usr/local/bin/k3s"
  register: k3s_check_installed
  check_mode: false

- name: check if reboot required
  stat:
    path: /var/run/reboot-required
  register: reboot_required_file

- name: reboot if required and we haven't installed k3s yet
  reboot:
    msg: "Rebooting after apt dist upgrade"
  when: reboot_required_file.stat.exists and not k3s_check_installed.stat.exists

- name: install k3s as additional master
  delegate_to: localhost
  become: false
  command:
    chdir: "~"
    cmd: >
      k3sup join 
      --server 
      --host={{ ansible_host }} 
      --server-host={{ k8s.initial_master_node_hostname }} 
      --k3s-version={{ k8s.k3s.version }} 
      --user={{ ansible_user }}
      --server-user={{ ansible_user }}
  when: not k3s_check_installed.stat.exists and inventory_hostname != k8s.initial_master_node_hostname
  tags: k8s_setup
