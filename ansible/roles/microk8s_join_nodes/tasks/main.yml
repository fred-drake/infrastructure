---
- name: check if node is already joined
  shell: "set -eo pipefail && microk8s kubectl get nodes | grep {{ cluster_master_host }} || echo None"
  args:
    executable: /usr/bin/bash
  register: node_list_output
  changed_when: 'False'
  when: "'k8s_rpi_master' not in group_names"

- name: make add-node call on master and collect join command
  shell: "set -eo pipefail && microk8s add-node | grep 'microk8s join' | head -1"
  args:
    executable: /usr/bin/bash
  register: node_join_command
  delegate_to: "{{ groups['k8s_rpi_master'][0] }}"
  when: "node_list_output.stdout == 'None'"

- name: execute join command on node
  command: "{{ node_join_command.stdout }}"
  when: "node_list_output.stdout == 'None'"
