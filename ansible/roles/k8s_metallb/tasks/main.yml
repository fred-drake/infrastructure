---
- name: create temporary file to store metallb namespace
  ansible.builtin.tempfile:
    state: file
    suffix: temp
  register: temp_namespace
  changed_when: False
  tags:
    - metallb
    - delete_metallb
    - k8s_setup

- name: create temporary file to store metallb
  ansible.builtin.tempfile:
    state: file
    suffix: temp
  register: temp_metallb
  changed_when: False
  tags:
    - metallb
    - delete_metallb
    - k8s_setup

- name: pull remote metallb namespace file
  get_url:
    url: "https://raw.githubusercontent.com/metallb/metallb/v{{ k8s.metallb.version }}/manifests/namespace.yaml"
    dest: "{{ temp_namespace.path }}"
    mode: '0644'
  changed_when: False
  tags:
    - metallb
    - delete_metallb
    - k8s_setup

- name: pull remote metallb file
  get_url:
    url: "https://raw.githubusercontent.com/metallb/metallb/v{{ k8s.metallb.version }}/manifests/metallb.yaml"
    dest: "{{ temp_metallb.path }}"
    mode: '0644'
  changed_when: False
  tags:
    - metallb
    - delete_metallb
    - k8s_setup

- name: apply metallb namespace
  k8s:
    state: present
    src: "{{ temp_namespace.path }}"
  tags:
    - metallb
    - k8s_setup

- name: apply metallb configuration
  k8s:
    state: present
    definition: "{{ lookup('template', 'metallb-configmap.yml') | from_yaml_all }}"
  tags:
    - metallb
    - k8s_setup

- name: apply metallb
  k8s:
    state: present
    src: "{{ temp_metallb.path }}"
  tags:
    - metallb
    - k8s_setup

- name: delete metallb
  k8s:
    state: absent
    src: "{{ temp_metallb.path }}"
  tags:
    - never
    - delete_metallb

- name: delete metallb configuration
  k8s:
    state: absent
    definition: "{{ lookup('template', 'metallb-configmap.yml') | from_yaml_all }}"
  tags:
    - never
    - delete_metallb

- name: delete metallb namespace
  k8s:
    state: absent
    src: "{{ temp_namespace.path }}"
  tags:
    - never
    - delete_metallb
